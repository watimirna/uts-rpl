@startuml Stock Opname Sequence Diagram

' Styling
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title Sequence Diagram - Proses Stock Opname (Implementasi Aktual)

actor "User" as User
participant "View\n(stock-opname.blade.php)" as View
participant "StockOpnameController" as Ctrl
participant "StockService" as Svc
participant "ProductStock" as Stock
participant "ProductTransaction" as Trans
database "Database" as DB

== 1. Menampilkan Halaman Stock Opname ==
User -> View: Buka menu Stock Opname
activate View
View -> Ctrl: index()
activate Ctrl

Ctrl -> DB: Product::with('productStock')->get()
activate DB
DB --> Ctrl: products[]
deactivate DB

Ctrl --> View: view('reports.stock-opname', products)
deactivate Ctrl
View --> User: Tampilkan daftar produk\ndengan stok saat ini
deactivate View

== 2. Input Stok Fisik ==
User -> View: Pilih produk, input counted_stock
activate View
note right
  Form input:
  - product_id
  - counted_stock (stok fisik)
  - note (opsional)
end note
View --> User: Tampilkan form
deactivate View

User -> View: Submit form stock opname
activate View
View -> Ctrl: store(Request)
activate Ctrl

Ctrl -> Ctrl: validate(request)
note right
  Validasi:
  - product_id: required, exists
  - counted_stock: required, integer, min:0
  - note: nullable, string, max:255
end note

== 3. Proses Penyesuaian Stok ==
Ctrl -> DB: DB::beginTransaction()
activate DB

Ctrl -> Svc: getCurrentStock(productId)
activate Svc
Svc -> Stock: find(productId)
activate Stock
Stock --> Svc: current_stock = 100
deactivate Stock
Svc --> Ctrl: currentStock = 100
deactivate Svc

Ctrl -> Ctrl: diff = counted - current
note right
  Contoh:
  counted = 95
  current = 100
  diff = 95 - 100 = -5
end note

alt diff > 0 (Kelebihan stok)
    Ctrl -> Svc: stockIn(productId, diff, 0, 'stock_opname', note)
    activate Svc
    Svc -> Trans: create(productId, qty_in=diff, type='stock_opname')
    activate Trans
    Trans --> Svc: transaction created
    deactivate Trans
    Svc -> Stock: updateStock(productId, qtyIn=diff, qtyOut=0)
    activate Stock
    Stock --> Svc: stock updated
    deactivate Stock
    Svc --> Ctrl: OK
    deactivate Svc

else diff < 0 (Kekurangan stok)
    Ctrl -> Svc: stockOut(productId, abs(diff), 0, 'stock_opname', note)
    activate Svc
    Svc -> Trans: create(productId, qty_out=abs(diff), type='stock_opname')
    activate Trans
    Trans --> Svc: transaction created
    deactivate Trans
    Svc -> Stock: updateStock(productId, qtyIn=0, qtyOut=abs(diff))
    activate Stock
    Stock --> Svc: stock updated
    deactivate Stock
    Svc --> Ctrl: OK
    deactivate Svc

else diff = 0 (Stok cocok)
    note right: Tidak ada perubahan diperlukan
end

Ctrl -> DB: DB::commit()
deactivate DB

Ctrl --> View: redirect()->route('stock-opname.index')\n->with('success', message)
deactivate Ctrl

View --> User: Tampilkan pesan sukses:\n"Stock adjusted successfully!" atau\n"No adjustment needed. Stock already matches."
deactivate View

@enduml
